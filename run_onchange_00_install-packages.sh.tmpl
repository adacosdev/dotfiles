{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash

# --- Progress Banner ---
echo -e "\033[0;34m"
echo "â–ˆâ–ˆâ–ˆâ–ˆ                 [20%] Fase 1/6: Instalando Paquetes del Sistema"
echo -e "\033[0m"

echo "ğŸ“¦ Iniciando instalaciÃ³n de paquetes..."

# --- Arch Linux / EndeavourOS ---
{{ if eq .chezmoi.osRelease.id "arch" "endeavouros" -}}
packages=(
{{ range .packages.arch -}}
  {{ . }}
{{ end -}}
)

# Bootstrap yay
if ! command -v yay &> /dev/null; then
    echo "ğŸ”§ Instalando yay..."
    sudo pacman -S --needed --noconfirm base-devel git
    sudo pacman -Sy --noconfirm archlinux-keyring
    git clone https://aur.archlinux.org/yay.git /tmp/yay
    cd /tmp/yay
    makepkg -si --noconfirm
    cd -
    rm -rf /tmp/yay
fi

echo "ğŸ”„ Sincronizando repositorios..."
sudo pacman -Sy --noconfirm archlinux-keyring

echo "ğŸ“¥ Instalando paquetes con yay..."
yay -S --needed --noconfirm "${packages[@]}"

# --- Debian / Ubuntu ---
{{ else if eq .chezmoi.osRelease.id "debian" "ubuntu" -}}
packages=(
{{ range .packages.ubuntu -}}
  {{ . }}
{{ end -}}
)

echo "ğŸ”„ Preparando repositorios externos..."
# VS Code Repo
if ! command -v code &> /dev/null; then
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
    sudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg
    sudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'
    rm -f packages.microsoft.gpg
fi

echo "ğŸ”„ Actualizando repositorios APT..."
sudo apt update

echo "ğŸ“¥ Instalando paquetes con apt..."
sudo apt install -y "${packages[@]}"

# Instalaciones extra para Ubuntu (que no suelen estar en apt o son viejas)

# Starship
if ! command -v starship &> /dev/null; then
    echo "ğŸš€ Instalando Starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# Eza (modern ls) - Intentar instalar si no estÃ¡
if ! command -v eza &> /dev/null; then
    echo "ğŸ“‚ Instalando eza (replacement for ls)..."
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
    sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
    sudo apt update
    sudo apt install -y eza
fi

# Bat (fix alias checking)
# En Ubuntu 'bat' se instala como 'batcat', crear symlink si no existe
if command -v batcat &> /dev/null && ! command -v bat &> /dev/null; then
    echo "ğŸ¦‡ Creando alias para bat..."
    mkdir -p ~/.local/bin
    ln -s /usr/bin/batcat ~/.local/bin/bat
fi

# LazyGit (Ubuntu install via binary if not in repo)
if ! command -v lazygit &> /dev/null; then
    echo "ğŸ’¤ Instalando LazyGit..."
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    sudo install lazygit /usr/local/bin
    rm lazygit lazygit.tar.gz
fi

# Git Delta (Better diffs)
if ! command -v delta &> /dev/null; then
    echo "â© Instalando Git Delta..."
    DELTA_VERSION=$(curl -s "https://api.github.com/repos/dandavison/delta/releases/latest" | grep -Po '"tag_name": "\K[^"]*')
    curl -Lo git-delta.deb "https://github.com/dandavison/delta/releases/download/${DELTA_VERSION}/git-delta_${DELTA_VERSION}_amd64.deb"
    sudo dpkg -i git-delta.deb
    rm git-delta.deb
fi

# Fd (fix alias checking)
# En Ubuntu 'fd' se instala como 'fdfind'
if command -v fdfind &> /dev/null && ! command -v fd &> /dev/null; then
    echo "ğŸ” Creando alias para fd..."
    mkdir -p ~/.local/bin
    ln -s /usr/bin/fdfind ~/.local/bin/fd
fi

{{ end -}}

echo "âœ… InstalaciÃ³n de paquetes completada."
{{ end -}}
